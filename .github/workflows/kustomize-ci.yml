name: kustomize-ci
on:
  push:
    branches:
      - main
    paths:
      - '**/kustomization.yaml'
  pull_request:
jobs:
  job:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        # directories with which we want to generate combined yaml manifest
        shared-starts: [
          'shared/online-boutique-asm-manifests/base',
          'shared/online-boutique-asm-manifests/service-accounts'
        ]
    steps:
      - uses: actions/checkout@v3
      - name: kustomize build
        env:
          KUSTOMIZE_DIR: ${{ matrix.shared-starts }}
        run: |
          cd $KUSTOMIZE_DIR
          FOLDER_NAME=$(KUSTOMIZE_DIR | awk -F/ '{print $NF}')
          kustomize build . > kubernetes-$FOLDER_NAME.yaml
      - uses: actions/checkout@v3
      - name: Push to PR
        with: 
          repo-token: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add .
          git commit -m "CI kustomize file"
          git push